---
name: Release repository

on:
    workflow_dispatch:
        inputs:
            target_branch:
                description: Target branch for the release.
                required: true
            version:
                description: New version (used for tag and package versioning).
                required: true
            release_name:
                description: Name of the release to be created. Version in the first place is recommended (e.g. `2.0.0-alpha`).
                required: true
            automatic_mode:
                type: boolean
                default: false
                description: Automatically merge PR and create release.
            prerelease:
                type: boolean
                default: false
                description: Mark the release as a prerelease.

jobs:
    release:
        name: Release repository
        runs-on: ubuntu-22.04
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            RELEASE_BRANCH: release-${{ github.event.inputs.version }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.target_branch }}

            - name: Create release branch
              run: |
                  git checkout -b $RELEASE_BRANCH
                  git push -u origin $RELEASE_BRANCH

            - name: Update docker image version
              uses: mikefarah/yq@v4.43.1
              with:
                  cmd: yq -i '.services.panther_ros.image = "new_tag"' demo/compose.minimal-setup.yaml

            - name: Create pull request
              run: |
                  gh pr create \
                  --base ${{ github.event.inputs.target_branch }} \
                  --head $RELEASE_BRANCH \
                  --title "Release ${{ github.event.inputs.version }}" \
                  --body "This PR incorporates package(s) version and changelog update."

            - name: Merge pull request
              if: ${{ github.event.inputs.automatic_mode == true }}
              run: |
                  gh pr merge $RELEASE_BRANCH \
                  --delete-branch

            - name: Create tag
              if: ${{ github.event.inputs.automatic_mode == true }}
              run: |
                  git checkout ${{ github.event.inputs.target_branch }}
                  git tag ${{ github.event.inputs.version }}
                  git push origin ${{ github.event.inputs.version }}

            - name: Create prerelease
              if: ${{ github.event.inputs.automatic_mode == true && github.event.inputs.prerelease == true}}
              run: |
                  gh release create ${{ github.event.inputs.version }} \
                  --title ${{ github.event.inputs.release_name }} \
                  --notes-from-tag \
                  --prerelease

            - name: Create release
              if: ${{ github.event.inputs.automatic_mode == true && github.event.inputs.prerelease == false}}
              run: |
                  gh release create ${{ github.event.inputs.version }} \
                  --title ${{ github.event.inputs.release_name }} \
                  --notes-from-tag
