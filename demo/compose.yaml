x-common-config:
  &common-config
  network_mode: host
  ipc: host
  restart: always

x-cpu-config:
  &cpu-config
  env_file: .env.cpu

x-gpu-config:
  &gpu-config
  runtime: nvidia
  env_file: .env.gpu

services:
  panther:
    image: husarion/panther:humble-nightly
    # build:
    #   context: ..
    #   dockerfile: Dockerfile.hardware
    <<: *common-config
    devices:
      - /dev/bus/usb
      - /dev/gpiochip0
      - /dev/spidev0.0
      - /dev/spidev0.1
    volumes:
      - ~/.ssh/id_rsa:/root/.ssh/id_rsa
      - /sys/bus/iio/devices:/sys/bus/iio/devices
      - /run/husarion/panther_config.env:/run/husarion/panther_config.env
      - /run/husarion/panther_config.yaml:/run/husarion/panther_config.yaml
    command: >
      ros2 launch panther_bringup bringup.launch.py

  gamepad_controller:
    image: husarion/joy2twist:humble-1.0.0-20231205
    <<: *common-config
    devices:
      - /dev/input/js0
    command: >
      bash -c
      "ros2 launch
      joy2twist gamepad_controller.launch.py
      joy2twist_params_file:=$(ros2 pkg prefix joy2twist)/share/joy2twist/config/joy2twist_panther.yaml"

  rviz:
    image: husarion/rviz2:humble-11.2.8-20231122
    <<:
      - *common-config
      - *cpu-config
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ./panther.rviz:/root/.rviz2/default.rviz
    environment:
      - DISPLAY=${DISPLAY:?You need to define display env}
      - LIBGL_ALWAYS_SOFTWARE=1
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
